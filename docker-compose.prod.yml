# docker-compose.prod.yml
# Production environment configuration
# Usage: docker compose -f docker-compose.prod.yml up -d
#
# Prerequisites:
# 1. Create a .env.prod file with required environment variables
# 2. Update DOMAIN_NAME to your actual domain
# 3. Update ACME_EMAIL for Let's Encrypt certificates

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.2
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=jenkins-connector-prod-network"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      # Let's Encrypt ACME
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-letsencrypt:/letsencrypt
    networks:
      - jenkins-connector-prod-network
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 3s
      retries: 3

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: jenkins-connector-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - jenkins-connector-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Jenkins Connector Application
  jenkins-connector:
    image: ghcr.io/ls1intum/jenkins-connector:${IMAGE_TAG}
    container_name: jenkins-connector
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # PostgreSQL configuration
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/${POSTGRES_DB`}
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      # Connection pool settings
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=10
      - SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE=5
      - SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT=30000
      # Jenkins configuration
      - JENKINS_URL=${JENKINS_URL:?JENKINS_URL is required}
      - JENKINS_USERNAME=${JENKINS_USERNAME:?JENKINS_USERNAME is required}
      - JENKINS_API_TOKEN=${JENKINS_API_TOKEN:?JENKINS_API_TOKEN is required}
      # Logging
      - LOGGING_LEVEL_ROOT=WARN
      - LOGGING_LEVEL_DE_TUM_CIT=INFO
      # JVM settings
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+HeapDumpOnOutOfMemoryError
    labels:
      - "traefik.enable=true"
      # HTTP Router
      - "traefik.http.routers.jenkins-connector.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.jenkins-connector.entrypoints=websecure"
      - "traefik.http.routers.jenkins-connector.tls.certresolver=letsencrypt"
      # Service
      - "traefik.http.services.jenkins-connector.loadbalancer.server.port=8081"
      # Health check
      - "traefik.http.services.jenkins-connector.loadbalancer.healthcheck.path=/actuator/health"
      - "traefik.http.services.jenkins-connector.loadbalancer.healthcheck.interval=30s"
      # Security headers middleware
      - "traefik.http.routers.jenkins-connector.middlewares=security-headers"
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
    networks:
      - jenkins-connector-prod-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 3s
      start_period: 30s
      retries: 3

# Volumes
volumes:
  postgres-data:
  traefik-letsencrypt:

# Networks
networks:
  jenkins-connector-prod-network:
    driver: bridge